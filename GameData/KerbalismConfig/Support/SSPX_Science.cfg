// =========================================================================
// SSPX Patch - CTT also included.
// The Fish Study is moved from the aquaculture part to the Lab,
// but the experiment now requires the part to be on the vessel
// Same end effect, except it's now run in the lab.
// The Plant growth is removed alltogether, as Kerbalism already has a similar experiment (CHILLED)
// =========================================================================
@KERBALISM_SCIENCE_VALUES:NEEDS[KerbalismScience,StationPartsExpansionRedux]
{
	SSPX
	{
	// the plant growth is replaced by Kerbalism's CHILLED. it's essentially the same thing, therefore there's no point in having multiple versions of the same experiment
		VisualObservation
		{
			ECCost = 1.16
			size = 112
			value = 6									// Low value due to lots of situations+ biomes.
			duration = 194								// 3-ish minutes
			requirements =
			CrewRequirement = Pilot@3
			ResourceRates =
			SetupMass = 0								// cupola exclusive experiments, shouldn;t really add more mass or cost. It's essentially looking out of the window, right?
			SetupCost = 0
			UnlockTech = advExploration
		}

		//Situation Mask changed to landed/Low Orbit.
		FishObservation
		{
			ECCost = 1.48
			size = 21832
			value = 24
			duration = 3888000							// 180 days
			requirements = 								//Part:sspx-aquaculture-375-1 - broken requirement.
			CrewRequirement = Scientist@4
			ResourceRates =								// quarter of resource consumption of a kerbal. Fish need oxygen, water, food to stay alive, i guess.
			SetupMass = 0								// because the experiment requires the aquaculture part on the vessel, there's no added cost or mass to the lab setup.
			SetupCost = 0
			UnlockTech = advScienceTech
		}
	}
}

// =========================================================================
// CTT patch for the Fish Observation. Everything else should be taken care of by SSPX's own CTT patch.
// =========================================================================
@KERBALISM_SCIENCE_VALUES:NEEDS[CommunityTechTree,KerbalismScience,StationPartsExpansionRedux]:BEFORE[Kerbalism]
{
	@SSPX
	{
		@FishObservation
		{
			@UnlockTech = longTermHabitation
		}
	}
}

// =========================================================================
// Removing/replacing provided experiment modules with our own.
// =========================================================================
@PART[*]:HAS[@MODULE:HAS[#experimentID[sspxFishStudy]]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]
{
	!MODULE:HAS[#experimentID[sspxFishStudy]]	{}
}

@PART[*]:HAS[@MODULE:HAS[#experimentID[sspxPlantGrowth]]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]
{
	!MODULE:HAS[#experimentID[sspxPlantGrowth]]	{}
}
!EXPERIMENT_DEFINITION:HAS[#id[sspxPlantGrowth]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]		{}

@PART[*]:HAS[@MODULE:HAS[#experimentID[sspxVisualObservation]]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]
{
	!MODULE:HAS[#experimentID[sspxVisualObservation]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = sspxVisualObservation
	}
}

// =========================================================================
// Patching the Experiments and the Definitions according to the values set in the tweakable above
// =========================================================================
@PART[*]:HAS[@MODULE[ModuleKsmExperiment]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]:FOR[Kerbalism]
{
	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[sspxVisualObservation]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/ECCost$
		%requires = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/requirements$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/duration$
		%resources = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/ResourceRates$
		%crew_operate = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/CrewRequirement$
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[sspxFishStudy]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/ECCost$
		%requires = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/requirements$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/duration$
		%resources = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/ResourceRates$
		%crew_operate = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/CrewRequirement$
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[sspxVisualObservation]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]:FOR[zzzKerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/SSPX/VisualObservation/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[sspxFishStudy]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]:FOR[zzzKerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/size$
	@dataScale /= #$baseValue$
	@situationMask = 17
	@biomeMask = 0
}

// =========================================================================
// Adding the Fish Study to the Laboratory Experiments Group
// =========================================================================
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]
{
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = sspxFishStudy
	}

	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		SETUP
		{
			name = Fish Species Observation
			desc = Installs a Fish Tank in the Laboratory, allowing you to observe their behavior in different environments. Don't forget to feed them once in a while!
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = sspxFishStudy
			}
		}
	}
}

// =========================================================================
// Patching the SETUP.
// =========================================================================
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[KerbalismScience,StationPartsExpansionRedux]:FOR[Kerbalism]
{
	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		@SETUP:HAS[#name[Fish?Species?Observation]]
		{
			%tech = #$../../@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/UnlockTech$
			%mass = #$../../@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/SetupMass$
			%cost = #$../../@KERBALISM_SCIENCE_VALUES/SSPX/FishObservation/SetupCost$
		}
	}
}
