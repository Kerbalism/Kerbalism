// Stocklike Station Parts Expansion Redux
// Last modified 2020-04-20 against SSPX 1.3.4

// ============================================================================
// SSPX deployable modules modify the part crew capacity after deployement.
// So before deleting the modules, patch the part crew capacity.
// ============================================================================

@PART[sspx-inflatable-cen*,sspx-expandable-cen*]:NEEDS[StationPartsExpansionRedux]:AFTER[Kerbalism]
{
	@CrewCapacity = #$MODULE[ModuleDeployableCentrifuge]/DeployedCrewCapacity$
}

@PART[sspx-inflatable-hab*]:NEEDS[StationPartsExpansionRedux]:AFTER[Kerbalism]
{
	@CrewCapacity = #$MODULE[ModuleDeployableHabitat]/DeployedCrewCapacity$
}

// ============================================================================
// Inflatables
// ============================================================================

@PART[sspx-inflatable-hab*]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableHabitat] {}

	MODULE
	{
		name = ModuleKsmHabitat
    maxShieldingFactor = 0.25
    deployWithPressure = true
    deployECRate = 0.0
    
    deployAnim = Expand
    deployAnimReverse = true
	}
}

// ============================================================================
// Inflatable gravity rings
// ============================================================================

@PART[sspx-inflatable-centrifuge-125-1]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableCentrifuge] {}

	MODULE
	{
		name = ModuleKsmHabitat
		volume = 34.0
		surface = 95.0
    maxShieldingFactor = 0.25
    deployWithPressure = true
    deployECRate = 0.0
    accelerateECRate = 7.5
    rotateECRate = 2.0
    
    deployAnim = Expand
    deployAnimReverse = true
    
    rotateAnim = SpinCenter
    rotateIsTransform = true
    rotateSpinRate = 42.0
    rotateAccelerationRate = 1.0
    
    counterweightAnim = SpinCenterCounter
    counterweightIsReversed = true
    counterweightIsTransform = true
    counterweightSpinRate = 84.0
    counterweightAccelerationRate = 2.0
	}
}

@PART[sspx-inflatable-centrifuge-125-2]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableCentrifuge] {}
  
	MODULE
	{
		name = ModuleKsmHabitat
		volume = 18.0
		surface = 55.0
    maxShieldingFactor = 0.25
    deployWithPressure = true
    deployECRate = 0.0
    accelerateECRate = 5.0
    rotateECRate = 1.0
    
    deployAnim = Expand
    deployAnimReverse = true
    
    rotateAnim = CompactSpinCentre
    rotateIsTransform = true
    rotateSpinRate = 35.0
    rotateAccelerationRate = 1.0
    
    counterweightAnim = CounterWeight
    counterweightIsReversed = true
    counterweightIsTransform = true
    counterweightSpinRate = 70.0
    counterweightAccelerationRate = 2.0
	}
}

@PART[sspx-inflatable-centrifuge-25-1]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableCentrifuge] {}
  
	MODULE
	{
		name = ModuleKsmHabitat
		volume = 85.0
		surface = 185.0
    maxShieldingFactor = 0.25
    deployWithPressure = true
    deployECRate = 0.0
    accelerateECRate = 15.0
    rotateECRate = 3.5
    
    deployAnim = Expand
    deployAnimReverse = true
    
    rotateAnim = B_Rotation
    rotateIsTransform = true
    rotateSpinRate = 45.0
    rotateAccelerationRate = 1.0
    
    counterweightAnim = 25mTorusCounterweight
    counterweightIsReversed = true
    counterweightIsTransform = true
    counterweightSpinRate = 90.0
    counterweightAccelerationRate = 2.0
	}
}

// ============================================================================
// Rigid gravity rings
// ============================================================================

@PART[sspx-expandable-centrifuge-375-1]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableCentrifuge] {}
  
	MODULE
	{
		name = ModuleKsmHabitat
		volume = 280.0
		surface = 510.0
    maxShieldingFactor = 1.0
    deployECRate = 5.0
    accelerateECRate = 35.0
    rotateECRate = 6.0
    
    deployAnim = CentrifugeCollapse
    deployAnimReverse = true
    
    rotateAnim = B_Center
    rotateIsTransform = true
    rotateSpinRate = 35.0
    rotateAccelerationRate = 1.0
    
    counterweightAnim = Counterweight
    counterweightIsReversed = true
    counterweightIsTransform = true
    counterweightSpinRate = 70
    counterweightAccelerationRate = 2.0
	}
}

@PART[sspx-expandable-centrifuge-375-2]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	!MODULE[ModuleDeployableCentrifuge] {}
  
	MODULE
	{
		name = ModuleKsmHabitat
		volume = 110.0
		surface = 190.0
    maxShieldingFactor = 1.0
    deployECRate = 3.0
    accelerateECRate = 25.0
    rotateECRate = 4.5
    
    deployAnim = Retract
    deployAnimReverse = true
    
    rotateAnim = SpinCenter
    rotateIsTransform = true
    rotateSpinRate = 35.0
    rotateAccelerationRate = 1.0
    
    counterweightAnim = Counterweights
    counterweightIsReversed = true
    counterweightIsTransform = true
    counterweightSpinRate = 70
    counterweightAccelerationRate = 2.0
	}
}

// ============================================================================
// Airlocks
// ============================================================================

@PART[sspx-airlock-125-1]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	@MODULE[ModuleKsmHabitat]
	{
    %volume = 0.7
		%depressurizationDuration = 2m
    %depressurizeECRate = 1.0
    %reclaimFactor = 0.90
    %reclaimStorageFactor = 2.0
	}
}

@PART[sspx-airlock-25-1]:NEEDS[StationPartsExpansionRedux,KerbalismLifeSupport]:AFTER[Kerbalism]
{
	@MODULE[ModuleKsmHabitat]
	{
    %volume = 4.0 
		%depressurizationDuration = 5m 
    %depressurizeECRate = 2.5
    %reclaimFactor = 0.90
    %reclaimStorageFactor = 4.0
	}
}

// ============================================================================
// Comforts
// ============================================================================

@PART[sspx-observation-25-1|sspx-cupola-125-1|sspx-cupola-375-1|sspx-expandable-centrifuge-375-1]:NEEDS[StationPartsExpansionRedux,KerbalismStress]:AFTER[Kerbalism]
{
	@MODULE[ModuleKsmHabitat]
	{
		comfort = panorama
	}
}

@PART[sspx-habitation-375-1|sspx-habitation-375-2|sspx-habitation-375-3|sspx-inflatable-hab-25-1|sspx-inflatable-hab-25-2]:NEEDS[StationPartsExpansionRedux,KerbalismStress]:AFTER[Kerbalism]
{
	@MODULE[ModuleKsmHabitat]
	{
		comfort = exercice
	}
}

@PART[sspx-greenhouse-25-1|sspx-greenhouse-375-1]:NEEDS[StationPartsExpansionRedux,KerbalismStress]:AFTER[Kerbalism]
{
	@MODULE[ModuleKsmHabitat]
	{
		comfort = plants
	}
}

// ============================================================================
// Radiation shelter
// ============================================================================
@PART[sspx-habitation-375-3]:NEEDS[StationPartsExpansionRedux,KerbalismRadiation]:AFTER[zzzKerbalism]
{
  @MODULE[ModuleKsmHabitat]
	{
		%maxShieldingFactor = 0.0
	}
  
  // TODO : this is based on the 65m2 of the bounding box, tweak this if we implement a better surface getting method 
	RESOURCE
	{
		name = KsmShielding
		amount = 65
		maxAmount = 65
    isTweakable = false
	}
}

// ============================================================================
// Greenhouses
// ============================================================================
@PART[sspx-greenhouse-25-1]:NEEDS[StationPartsExpansionRedux]:AFTER[Kerbalism]
{
	MODULE
	{
		name = Greenhouse
		crop_resource = Food								// name of resource produced by harvests
		// Twice as effective as kerbalism-greenhouse part.
		// See https://forum.kerbalspaceprogram.com/index.php?/topic/172400-131145-kerbalism-v180/&page=32&tab=comments#comment-3446891 for details.

		// This greenhouse has 18 independent sections! It's 18 staged crops in rotation. Almost non-stop production, but each harvest is 18 times smaller.
		crop_size = 3.0625									// 18 times less harvest than 2x"kerbalism-greenhouse"
		crop_rate = 0.00000416664					 // but you can harvest 18 times more often due to independent sections!
		ec_rate = 5												 // 2x"kerbalism-greenhouse"
		light_tolerance = 400.0						 // minimum lighting flux required for growth, in W/m^2
		pressure_tolerance = 0.1						// minimum pressure required for growth, in sea level atmospheres
		radiation_tolerance = 0.000008333	 // maximum radiation allowed for growth in rad/s, considered after shielding is applied
		shutters = 25DoorsOpen							// animation to manipulate shutters
		animBackwards = True

		INPUT_RESOURCE
		{
			name = Ammonia
			rate = 0.00019140625							// 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = Water
			rate = 0.0000063802							 // 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = KsmWasteAtmosphere						// Plants work on WasteAtmosphere and replace a scrubber, if not enough WasteAtmosphere exists then CO2 is used
			rate = 0.0024915995							 // 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = CarbonDioxide							// Kerbals don't provide enough WasteAtmosphere for their required food production. If excess WasteAtmosphere is
																				// present then it will be used in place of CO2 injection
			rate = 0.00083053315							// 2x"kerbalism-greenhouse"
		}

		// Note. if there is a deficiency in the amount of WasteAtmosphere needed then the missing amount of WasteAtmosphere will be added to the
		// CarbonDioxide input and Vies Versa if not enough CarbonDioxide is present and there is extra WasteAtmosphere.
		// If there is not enough resources then the plants will suffer.

		OUTPUT_RESOURCE
		{
			name = Oxygen
			rate = 0.0034475965							 // 200% of oxygen required by 1 crew member
		}
	}

	RESOURCE
	{
		name = Ammonia
		amount = 544												// 2x"kerbalism-greenhouse"
		maxAmount = 544
	}

	RESOURCE
	{
		name = CarbonDioxide
		amount = 9000											 // 2x"kerbalism-greenhouse"
		maxAmount = 9000
	}

	// To support pressure control
	@MODULE[Configure]
	{
		@SETUP[Pressure?Control]
		{
			!RESOURCE[Nitrogen] {}
		}
	}

	RESOURCE
	{
		name = Nitrogen
		amount = 10000											// 1x"kerbalism-greenhouse" as it does not mess with crops
		maxAmount = 10000
	}

	RESOURCE
	{
		name = Water
		amount = 22												 // 2x"kerbalism-greenhouse"
		maxAmount = 22
	}

	!MODULE[ModuleAnimateGeneric] {}			// Greenhouse handles animation
}

@PART[sspx-greenhouse-375-1]:NEEDS[StationPartsExpansionRedux]:AFTER[Kerbalism]
{
	MODULE
	{
		name = Greenhouse

		crop_resource = Food								// name of resource produced by harvests
		// Twice as effective as kerbalism-greenhouse part.
		// See https://forum.kerbalspaceprogram.com/index.php?/topic/172400-131145-kerbalism-v180/&page=32&tab=comments#comment-3446891 for details.

		// Both growing "rings" of this greenhouse are unfortunately in the same section. No independent growing possible. (Different watering and lighting needs for different grow stages).
		crop_size = 55.125									// 2x kerbalism-greenhouse
		crop_rate = 0.00000023148					 // regular growth speed
		ec_rate = 5												 // 2x"kerbalism-greenhouse"
		light_tolerance = 400.0						 // minimum lighting flux required for growth, in W/m^2
		pressure_tolerance = 0.1						// minimum pressure required for growth, in sea level atmospheres
		radiation_tolerance = 0.000008333	 // maximum radiation allowed for growth in rad/s, considered after shielding is applied

		INPUT_RESOURCE
		{
			name = Ammonia
			rate = 0.00019140625							// 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = Water
			rate = 0.0000063802							 // 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = KsmWasteAtmosphere						// Plants work on WasteAtmosphere and replace a scrubber, if not enough WasteAtmosphere exists then CO2 is used
			rate = 0.0024915995							 // 2x"kerbalism-greenhouse"
		}

		INPUT_RESOURCE
		{
			name = CarbonDioxide							// Kerbals don't provide enough WasteAtmosphere for their required food production. If excess WasteAtmosphere is
																				// present then it will be used in place of CO2 injection
			rate = 0.00083053315							// 2x"kerbalism-greenhouse"
		}

		// Note. if there is a deficiency in the amount of WasteAtmosphere needed then the missing amount of WasteAtmosphere will be added to the
		// CarbonDioxide input and Vies Versa if not enough CarbonDioxide is present and there is extra WasteAtmosphere.
		// If there is not enough resources then the plants will suffer.

		OUTPUT_RESOURCE
		{
			name = Oxygen
			rate = 0.0034475965							 // 200% of oxygen required by 1 crew member
		}
	}

	//	Concider those nice IVA tanks and closets for increasing current resource capacity. I won't touch em for now.
	RESOURCE
	{
		name = Ammonia
		amount = 544												// 2x"kerbalism-greenhouse"
		maxAmount = 544
	}

	RESOURCE
	{
		name = CarbonDioxide
		amount = 9000											 // 2x"kerbalism-greenhouse"
		maxAmount = 9000
	}

	// To support pressure control
	@MODULE[Configure]
	{
		@SETUP[Pressure?Control]
		{
		!RESOURCE[Nitrogen] {}
		}
	}

	RESOURCE
	{
		name = Nitrogen
		amount = 10000											// 1x"kerbalism-greenhouse" as it does not mess with crops
		maxAmount = 10000
	}

	RESOURCE
	{
		name = Water
		amount = 22												 // 2x"kerbalism-greenhouse"
		maxAmount = 22
	}
}

// ============================================================================
// region Containers
// ============================================================================
@PART[sspx-cargo-container*]:NEEDS[StationPartsExpansionRedux,CommunityResourcePack,!ProfileNone]:AFTER[zzzKerbalism]
{
	@MODULE[ModuleB9PartSwitch]:HAS[!SUBTYPE[Food]]
	{
		SUBTYPE
		{
			name = Food
			tankType = Food
			title = #KERBALISM_SupplyContainer_food // Food
			transform = SnacksDecal
		}
	}
	@MODULE[ModuleB9PartSwitch]:HAS[!SUBTYPE[Supplies]]
	{
		SUBTYPE
		{
			name = Supplies
			tankType = Supplies
			title = #KERBALISM_SupplyContainer_supplies // Supplies
			transform = SuppliesDecal
		}
	}
	@MODULE[ModuleB9PartSwitch]:HAS[!SUBTYPE[Waste]]
	{
		SUBTYPE
		{
			name = Waste
			tankType = Waste
			title = #KERBALISM_SupplyContainer_waste // Waste
			transform = LifeSupportDecal
		}
	}
}
// end
