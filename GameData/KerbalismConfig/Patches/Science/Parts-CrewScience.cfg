//==============================================================================
// Add crew experiments to tagged parts
//==============================================================================

// Parts tagged with kerbalismCrewScience will have crew experiments added
@PART[ScienceBox,crewCabin]:FOR[Kerbalism]:NEEDS[KerbalismScience]
{
  kerbalismCrewScience = true
}

// Remove crew report from all crewed parts that have no command module
@PART[*]:HAS[@MODULE[!ModuleCommand]:HAS[#minimumCrew[>0]]]:FOR[Kerbalism]:NEEDS[KerbalismScience]
{
  !MODULE[ModuleKsmExperiment]:HAS[#moduleDefinition[crewReport]] {}
}

// AFTER Kerbalism so that other mods get a chance
// to tag parts with kerbalismCrewScience
@PART[*]:HAS[#kerbalismCrewScience]:AFTER[Kerbalism]:NEEDS[KerbalismScience]
{
  !kerbalismCrewScience = delete

  MODULE
  {
    name = ModuleKsmExperiment
    moduleIdentifier = kerbalismCrewScience
  }

  MODULE
  {
    name = ModuleB9PartSwitch
    switcherDescription = #autoLoc_6003059 // Science Experiment
    moduleID = crewScienceExperiment
    affectDragCubes = false
    affectFARVoxels = false

    SUBTYPE
		{
			name = empty
			title = #kerbalism-part-empty
      primaryColor = KSPNeutralUIGrey

      MODULE
      {
        moduleActive = false
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
      }
		}

    SUBTYPE
		{
			name = crewReport
			title = #kerbalism-experiment-crewreport-title
      primaryColor = Green
      addedCost = 40
      addedMass = 0.001

      MODULE
      {
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
        DATA 
        {
          moduleDefinition = #$../../name$
        }
      }
		}

    SUBTYPE
		{
			name = kerbalism_FLIGHT
			title = #kerbalism-experiment-flight-title
      primaryColor = CoolBlue
      addedCost = 100
      addedMass = 0.001

      MODULE
      {
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
        DATA 
        {
          moduleDefinition = #$../../name$
        }
      }
		}

    SUBTYPE
		{
			name = kerbalism_FLOAT
			title = #kerbalism-experiment-float-title
      primaryColor = Cream
      addedCost = 350
      addedMass = 0.004

      MODULE
      {
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
        DATA 
        {
          moduleDefinition = #$../../name$
        }
      }
		}

    SUBTYPE
    {
      name = kerbalism_LEAVE
      title = #kerbalism-experiment-leave-title
      primaryColor = DarkMint
      addedCost = 1575
      addedMass = 0.025

      MODULE
      {
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
        DATA 
        {
          moduleDefinition = #$../../name$
        }
      }
    }

    SUBTYPE
    {
      name = kerbalism_SITE
      title = #kerbalism-experiment-clam-title
      primaryColor = Azure
      addedCost = 1300
      addedMass = 0.68

      MODULE
      {
        IDENTIFIER 
        {
          name = ModuleKsmExperiment
          moduleIdentifier = kerbalismCrewScience
        }
        DATA 
        {
          moduleDefinition = #$../../name$
        }
      }
    }
  }
}

// Add an additional option to the science box: STAKE resupply
@PART[ScienceBox]:AFTER[Kerbalism]:NEEDS[KerbalismScience]
{
  @MODULE[ModuleB9PartSwitch]
  {
    baseVolume = 50

    !SUBTYPE[crewReport] {}

    SUBTYPE
    {
      name = stakeRessuply
      title = #kerbalism-stake-resupply-title
      descriptionSummary = #kerbalism-stake-resupply-desc
      primaryColor = Green
      addedCost = 3300
      addedMass = 0.05
      tankType = StakeGranulate
    }
  }
}
