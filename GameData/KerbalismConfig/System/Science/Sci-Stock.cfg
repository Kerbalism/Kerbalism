// ============================================================================
// Kerbalism changes to stock science
// ============================================================================

@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    Description = #kerbalism-experiment-crewreport-desc
    DataSize = 0.2
    SciencePoints = 3

    MODULE_DEFINITION
    {
      name = crewReport // <- this is referenced from ModuleKsmExperiment.id
      Duration = 4m30s
      RequiredEC = 0.01
      CrewOperate = True
    }

    Situation = Surface@Biomes
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 0.25
    SciencePoints = 10

    MODULE_DEFINITION
    {
      name = evaReport
      Duration = 45s
      RequiredEC = 0.02
    }

    Situation = Surface@Biomes
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    SampleMass = 0.025
    DataSize = 980
    SciencePoints = 22

    MODULE_DEFINITION
    {
      name = surfaceSample
      Duration = 40s
      RequiredEC = 0.06
      Samples = 1
      SampleCollecting = True
      Requirements = AstronautComplexLevelMin:2,RndFacilityLevelMin:2
    }

    Situation = SrfLanded@Biomes
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[mysteryGoo]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    SampleMass = 0.0073
    DataSize = 429
    SciencePoints = 6

    MODULE_DEFINITION
    {
      name = mysteryGoo
      Duration = 10m30s
      RequiredEC = 0.18
      Samples = 1
    }

    Situation = SrfLanded
    Situation = SrfSplashed
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    SampleMass = 0.032
    DataSize = 2400
    SciencePoints = 18

    MODULE_DEFINITION
    {
      name = mobileMaterialsLab
      RequiredEC = 2.04
      Duration = 20m            //20-ish min. (low duration due to aids with manually flying in atmo)
      Samples = 1
    }

    SampleMass = 0.032
    Situation = SrfLanded
    Situation = SrfSplashed
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 0.45
    SciencePoints = 3

    MODULE_DEFINITION
    {
      name = temperatureScan
      Duration = 2m10s
      RequiredEC = 0.002
    }

    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 3.5
    SciencePoints = 9

    MODULE_DEFINITION
    {
      name = barometerScan
      Duration = 15m
      RequiredEC = 0.05
    }

    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    BodyAllowed = Atmospheric
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[seismicScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 200
    SciencePoints = 12

    MODULE_DEFINITION
    {
      name = seismicScan
      Duration = 14d
      RequiredEC = 0.0076
    }

    Situation = SrfLanded@Biomes
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 26014
    SciencePoints = 16

    MODULE_DEFINITION
    {
      name = gravityScan
      Duration = 90d
      RequiredEC = 0.041
    }

    Situation = Surface@Biomes
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 4
    SciencePoints = 16

    MODULE_DEFINITION
    {
      name = atmosphereAnalysis
      Duration = 45s
      RequiredEC = 2.4
    }

    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    BodyAllowed = Atmospheric
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  // note: we use the stock ModuleAsteroid experiment that we patch at runtime, the sample mass
  // is defined globally in settings.cfg
  KERBALISM_EXPERIMENT
  {
    DataSize = 1694
    SciencePoints = 35

    Situation = SrfLanded@Biomes
    Situation = SrfSplashed@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[infraredTelescope]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  KERBALISM_EXPERIMENT
  {
    DataSize = 289386462
    SciencePoints = 800

    MODULE_DEFINITION
    {
      name = infraredTelescope
      Duration = 12y
      RequiredEC = 1.4
    }

    Situation = InSpaceHigh
    BodyAllowed = HomeBody
  }
}

// ============================================================================
// Replacing stock experiments with our own, one by one.
// Affects all parts that use both the stock module AND stock experiments.
// ============================================================================
@PART[*]:HAS[@MODULE:HAS[#experimentID[atmosphereAnalysis]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[atmosphereAnalysis]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = atmosphereAnalysis
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[mysteryGoo]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[mysteryGoo]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = mysteryGoo
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[mobileMaterialsLab]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[mobileMaterialsLab]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = mobileMaterialsLab
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[seismicScan]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[seismicScan]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = seismicScan
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[barometerScan]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[barometerScan]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = barometerScan
    allow_shrouded = False
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[gravityScan]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[gravityScan]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = gravityScan
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[temperatureScan]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[temperatureScan]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = temperatureScan
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[infraredTelescope]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[infraredTelescope]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = infraredTelescope
  }
}
@PART[kerbalEVA*]:HAS[@MODULE[ModuleTripLogger]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[surfaceSample]]  {}
  !MODULE:HAS[#experimentID[evaReport]]    {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = surfaceSample
    hide_when_invalid = True
  }
  MODULE
  {
    name = ModuleKsmExperiment
    id = evaReport
  }
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[crewReport]]]:NEEDS[KerbalismScience]
{
  !MODULE:HAS[#experimentID[crewReport]]  {}
  MODULE
  {
    name = ModuleKsmExperiment
    id = crewReport
  }
}

// ============================================================================
// Animation fix for goo container & materials bay
// ============================================================================
@PART[GooExperiment,science_module]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
  !MODULE[ModuleAnimateGeneric]    {}
  @MODULE[ModuleKsmExperiment]
  {
    %anim_deploy = Deploy
  }
}

// ============================================================================
// Remove scientist bonus
// ============================================================================
@EXPERIENCE_TRAIT[Scientist]:NEEDS[KerbalismScience]
{
  @desc = Scientists can reset experiments.
  @EFFECT[VesselScienceReturn] { @modifiers = 1, 1, 1, 1, 1 }
  @EFFECT[PartScienceReturn]   { @modifiers = 1, 1, 1, 1, 1 }
}

// ======================================================================
// adds sensors to gravioli/radiation/temperature/pressure to all parts that use
// the stock experiments and do not already have one.
// ============================================================================

@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[radiation]],@MODULE[ModuleKsmExperiment]:HAS[#id[geigerCounter]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
  !MODULE[ModuleEnviroSensor] {}
  MODULE
  {
    name = Sensor
    type = radiation
  }
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[gravioli]],@MODULE[ModuleKsmExperiment]:HAS[#id[gravityScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
  !MODULE[ModuleEnviroSensor] {}
  MODULE
  {
    name = Sensor
    type = gravioli
  }
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[temperature]],@MODULE[ModuleKsmExperiment]:HAS[#id[temperatureScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
  !MODULE[ModuleEnviroSensor] {}
  MODULE
  {
    name = Sensor
    type = temperature
  }
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[pressure]],@MODULE[ModuleKsmExperiment]:HAS[#id[barometerScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
  !MODULE[ModuleEnviroSensor] {}
  MODULE
  {
    name = Sensor
    type = pressure
  }
}
