// ============================================================================
// Remove stock science data containers, add hard-drives instead
// ============================================================================

@PART[*]:HAS[@MODULE[ModuleScienceContainer]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  !MODULE[ModuleScienceContainer] {}
}

@PART[*]:HAS[@MODULE[ModuleCommand]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  MODULE
  {
    name = HardDrive
    dataCapacity = 4.625    // data size in Mb
    sampleCapacity = 4      // sample size in slots
  }
}

@PART[kerbalEVA*]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  MODULE
  {
    name = HardDrive
    dataCapacity = 0.625    // 640kb should be enough for everyone
    sampleCapacity = 2
  }
}

@PART[ScienceBox]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  MODULE
  {
    name = HardDrive
    dataCapacity = 24
    sampleCapacity = 14
  }
}


// ============================================================================
// Replace stock lab with our own
// ============================================================================

@PART[*]:HAS[@MODULE[ModuleScienceLab]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  !MODULE[ModuleScienceLab] {}
  !MODULE[ModuleScienceConverter] {}

  MODULE
  {
    name = Laboratory
    researcher = Scientist
    analysis_rate = 0.005 // 5 kbps
    ec_rate = 1.0
  }

  MODULE
  {
    name = HardDrive
    dataCapacity = 20000
    sampleCapacity = 20000
  }
}

// ============================================================================
// Remove stock science experiments and replace them with our own
// ============================================================================

@PART[*]:HAS[@MODULE[ModuleScienceExperiment]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  MODULE
  {
    name = Experiment
    experiment_id = #$../MODULE[ModuleScienceExperiment]/experimentID$
    ec_rate = 0          // emulate stock: no ec needed, instant transmission
    data_rate = 999
  }

  !MODULE[ModuleScienceExperiment] {}
}


// ============================================================================
// Configure experiments.
//
// Put desired scientific value into scienceCap, that will
// later be copied onto baseValue. We need to do this because KSP calculates
// the size of an experiment thusly: dataScale * scienceCap = size in Mb
//
// In Kerbalism terms...
// scienceCap = the scientific base value of an experiment (science points)
// dataScale = megabytes per science point
// ============================================================================


// crewReport -----------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 6              // desired science points
  @dataScale = 0.206           // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[crewReport]]
  {
    %data_rate = 0.206
    @data_rate /= 300            // ... divide that by duration in seconds
    %experiment_desc = A short and unprecise situation report
    crew_operate = true
  }
}


// evaReport ------------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 6              // desired science points
  @dataScale = 0.22            // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[evaReport]]
  {
    %data_rate = 0.22
    @data_rate /= 120           // ... divide that by duration in seconds
    %requires = Surface
  }
}


// temperatureScan ------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 22             // desired science points
  @dataScale = 1.8             // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[temperatureScan]]
  {
    %data_rate = 1.8
    @data_rate /= 900          // ... divide that by duration in seconds
  }
}


// geigerCounter --------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[geigerCounter]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 26             // desired science points
  @dataScale = 2.2             // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[geigerCounter]]
  {
    %data_rate = 2.2
    @data_rate /= 1300          // ... divide that by duration in seconds
  }
}


// mysteryGoo -----------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[mysteryGoo]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 8              // desired science points
  @dataScale = 1               // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]
  {
    %data_rate = 1
    @data_rate /= 600            // ... divide that by duration in seconds
    %experiment_desc = The infamous Mystery Goo, trapped in a container so it can't run away
    %sample_mass = 0.00073
    %ec_rate = 0.001
    %anim_deploy = Deploy
  }
}


// surfaceSample --------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @scienceCap = 24             // desired science points
  @dataScale = 6               // desired size in Mb/Slots
  @dataScale /= #$scienceCap$  // magic to make it work
}

@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @MODULE[Experiment]:HAS[#experiment_id[surfaceSample]]
  {
    %data_rate = 6
    @data_rate /= 165          // ... divide that by duration in seconds
    %sample_mass = 0.012
    %sample_collecting = true
  }
}

// ============================================================================
// Change situation/biome masks for some experiments
// ============================================================================

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:FOR[Kerbalism]           { @situationMask = 51 }
@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]         { @situationMask = 48 }
@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:FOR[Kerbalism]           { @biomeMask = 3      }
@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]     { @biomeMask = 3      }
@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]         { @biomeMask = 48     }
@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[FeatureScience]:FOR[Kerbalism]  { @biomeMask = 0      }
@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]      { @biomeMask = 0      }


// ============================================================================
// Tweak science values for experiments
// ============================================================================
@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]      { @baseValue = 8  }
@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]        { @baseValue = 8  }
@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[FeatureScience]:FOR[Kerbalism]   { @baseValue = 16 }
@EXPERIMENT_DEFINITION:HAS[#id[seismicScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]          { @baseValue = 12 }
@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]          { @baseValue = 12 }
@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[FeatureScience]:FOR[Kerbalism]   { @baseValue = 12 }
@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]       { @baseValue = 36 }


// ============================================================================
// Tweak experiments data scales
// ============================================================================
@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[FeatureScience]:FOR[Kerbalism]   { @dataScale = 33 }
@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]        { @dataScale = 31 }
@EXPERIMENT_DEFINITION:HAS[#id[seismicScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]          { @dataScale = 45 }
@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]          { @dataScale = 51 }
@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[FeatureScience]:FOR[Kerbalism]   { @dataScale = 66 }
@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]       { @dataScale = 34 }


// ============================================================================
// Tweak experiments title
// ============================================================================


@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]        { @title = Pressure Scan   }
@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]       { @title = Asteroid Scan   }


// ============================================================================
// Copy Science Value onto Base Value (see above)
// ============================================================================

@EXPERIMENT_DEFINITION:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
  @baseValue = #$scienceCap$
}


// ============================================================================
// Remove scientist bonus
// ============================================================================

@EXPERIENCE_TRAIT[Scientist]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  @desc = Scientists can reset experiments.
  @EFFECT[VesselScienceReturn] { @modifiers = 1, 1, 1, 1, 1 }
  @EFFECT[PartScienceReturn]   { @modifiers = 1, 1, 1, 1, 1 }
}


// ============================================================================
// Lab module satisfy stock contracts
// ============================================================================

@Contracts:NEEDS[FeatureScience]:FOR[Kerbalism]
{
  @Base
  {
    @PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
  }
  @Station
  {
    @PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
  }
}
